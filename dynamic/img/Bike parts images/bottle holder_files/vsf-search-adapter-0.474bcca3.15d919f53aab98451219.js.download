(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{1032:function(e,r,t){"use strict";t.r(r),t.d(r,"SearchAdapter",(function(){return m}));var s=t(0),o=t(366),n=(t(194),t(1));function i(e){return function(e){let r=n.elasticsearch.hasOwnProperty("searchScoring")?n.elasticsearch.searchScoring:{},t=r.hasOwnProperty("minimum_should_match")?r.minimum_should_match:"75%";"GET"===n.elasticsearch.queryMethod&&(t=encodeURIComponent(t));let s={query:e,operator:r.operator?r.operator:"or",fuzziness:r.fuzziness?r.fuzziness:"2",cutoff_frequency:r.cutoff_frequency?r.cutoff_frequency:"0.01",max_expansions:r.max_expansions?r.max_expansions:"3",prefix_length:r.prefix_length?r.prefix_length:"1",minimum_should_match:t,tie_breaker:r.tie_breaker?r.tie_breaker:"1"};return r.hasOwnProperty("analyzer")&&(s.analyzer=r.analyzer),s}(e)}function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=[];return n.elasticsearch.hasOwnProperty("searchableAttributes")&&n.elasticsearch.searchableAttributes[e]&&(r=n.elasticsearch.searchableAttributes[e]),r.hasOwnProperty("boost")?r.boost:1}function c(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"products",t=[];return n.hasOwnProperty(r)&&n[r].hasOwnProperty("filterFieldMapping")&&(t=n[r].filterFieldMapping),t.hasOwnProperty(e)?t[e]:e}var a=t(42);async function l(e){const r=await Promise.all([t.e(63),t.e(66),t.e(70),t.e(72),t.e(73),t.e(68),t.e(74),t.e(38),t.e(39),t.e(28),t.e(69)]).then(t.t.bind(null,1036,7)),s=e.getSearchText(),o=["gt","lt","gte","lte","moreq","from","to"];let l=r.default();const h=Object(a.a)(e.getAppliedFilters());if(h.length>0){let e=!1;h.forEach(r=>{"default"===r.scope?Object.keys(r.value).every(e=>o.includes(e))?l=l.filter("range",r.attribute,r.value):(r.value=r.value[Object.keys(r.value)[0]],Array.isArray(r.value)||(r.value=[r.value]),l=r.options.negate?l.notFilter("terms",c(r.attribute),r.value):l.filter("terms",c(r.attribute),r.value)):"catalog"===r.scope&&(e=!0)});let r=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return h.forEach(t=>{const s=Object.keys(t.value);if("catalog"===t.scope&&s.length){if(s.filter(e=>-1!==o.indexOf(e)).length){let r=t.attribute;"price"===r&&(r=n.products.priceFilterKey),e=e.andFilter("range",r,t.value)}else{let s=t.value[Object.keys(t.value)[0]];Array.isArray(s)||(s=[s]),e=t.options.negate?e.notFilter("terms",c(t.attribute)+r,s):e.andFilter("terms",c(t.attribute)+r,s)}}}),e};e&&(l=l.filterMinimumShouldMatch(1).orFilter("bool",r).orFilter("bool",e=>r(e,"_options").filter("match","type_id","configurable")))}const y=e.getAvailableFilters();if(y.length>0)for(let e of y)if("catalog"===e.scope)if("price"!==e.field){let r={size:n.products.filterAggregationSize[e.field]||n.products.filterAggregationSize.default};l=l.aggregation("terms",c(e.field),r),l=l.aggregation("terms",e.field+"_options",r)}else l=l.aggregation("terms",e.field),l.aggregation("range","price",n.products.priceFilters);let p=function(e){let r=n.elasticsearch.hasOwnProperty("searchableAttributes")?n.elasticsearch.searchableAttributes:{name:{boost:1}},t=[];for(const e of Object.keys(r))t.push(e+"^"+u(e));return e.orQuery("multi_match","fields",t,i(s)).orQuery("bool",e=>e.orQuery("terms","configurable_children.sku",s.split("-")).orQuery("match_phrase","sku",{query:s,boost:1}).orQuery("match_phrase","configurable_children.sku",{query:s,boost:1}))};if(""!==s){let e=function(){if(!n.elasticsearch.hasOwnProperty("searchScoring"))return!1;let e=[],r=n.elasticsearch.searchScoring.attributes;if(!Object.keys(r).length)return!1;for(const t of Object.keys(r))for(const s of Object.keys(r[t].scoreValues)){let o={filter:{match:{[t]:s}},weight:r[t].scoreValues[s].weight};e.push(o)}return!!e.length&&{functions:e,score_mode:n.score_mode?n.score_mode:"multiply",boost_mode:n.boost_mode?n.boost_mode:"multiply",max_boost:n.max_boost?n.max_boost:100,min_score:n.function_min_score?n.function_min_score:1}}();l=e?l.query("function_score",e,p):l.query("bool",p)}const f=l.build();return e.suggest&&(f.suggest=e.suggest),f}var h=t(234),y=t.n(h),p=t(3),f=t(256),g=t.n(f),d=t(6),_=t(15),m=function(){function e(){this.entities=[],this.initBaseTypes(),this.initCustomTypes()}return e.prototype.getHostnameFromUrl=function(e){if("string"==typeof e){var r=new RegExp(["^(https?:)//","(([^:/?#]*)(?::([0-9]+))?)","(/{0,1}[^?#]*)","(\\?[^#]*|)","(#.*|)$"].join("")),t=e.match(r);return t?t[2]:e}return e},e.prototype.search=function(e){return s.b(this,void 0,void 0,(function(){var r,t,o,i,u;return s.c(this,(function(s){switch(s.label){case 0:if(!this.entities[e.type])throw new Error("No entity type registered for "+e.type);return r={},e.searchQuery instanceof _.a?[4,l(e.searchQuery)]:[3,2];case 1:return r=s.sent(),""!==e.searchQuery.getSearchText()&&(r.min_score=n.elasticsearch.min_score),[3,3];case 2:r=e.searchQuery,s.label=3;case 3:return e.hasOwnProperty("groupId")&&null!==e.groupId&&(r.groupId=e.groupId),e.hasOwnProperty("groupToken")&&null!==e.groupToken&&(r.groupToken=e.groupToken),null!==e.store?[3,4]:(o=Object(d.b)(),[3,6]);case 4:return[4,Object(d.g)(e.store)];case 5:o=s.sent(),s.label=6;case 6:if(t=o,e.index=t.elasticsearch.index,i=Object(p.k)(p.g&&t.elasticsearch.serverhost?t.elasticsearch.serverhost:t.elasticsearch.host),this.entities[e.type].url&&(i=this.entities[e.type].url),u={size:e.size,from:e.from,sort:e.sort},e._sourceExclude&&(u._source_exclude=e._sourceExclude.join(",")),e._sourceInclude&&(u._source_include=e._sourceInclude.join(",")),e.q&&(u.q=e.q),!e.index||!e.type)throw new Error("Query.index and Query.type are required arguments for executing ElasticSearch query");return"GET"===n.elasticsearch.queryMethod&&(u.request=JSON.stringify(r)),i=(i=i+"/"+encodeURIComponent(e.index)+"/"+encodeURIComponent(e.type)+"/_search")+"?"+g.a.stringify(u),[2,y()(i,{method:n.elasticsearch.queryMethod,mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json",Host:this.getHostnameFromUrl(t.elasticsearch.host)},body:"POST"===n.elasticsearch.queryMethod?JSON.stringify(r):null,keepalive:!0}).then((function(e){return e.json()})).catch((function(e){throw console.error(e),new Error("FetchError in request to "+i+"  ES:"+e.toString())}))]}}))}))},e.prototype.handleResult=function(e,r,t,s){if(void 0===t&&(t=0),void 0===s&&(s=50),null===e)throw new Error("Invalid ES result - null not exepcted");if(e.hasOwnProperty("hits"))return{items:Object(o.a)(e.hits.hits,(function(e){return Object.assign(e._source,{_score:e._score,slug:e._source.slug?e._source.slug:e._source.hasOwnProperty("url_key")&&n.products.useMagentoUrlKeys?e._source.url_key:e._source.hasOwnProperty("name")?Object(p.p)(e._source.name)+"-"+e._source.id:""})})),total:e.hits.total,start:t,perPage:s,aggregations:e.aggregations,suggestions:e.suggest};throw e.error?new Error(JSON.stringify(e.error)):new Error("Unknown error with elasticsearch result in resultPorcessor for entity type '"+r+"' with response: "+JSON.stringify(e))},e.prototype.registerEntityType=function(e,r){var t=r.url,s=void 0===t?"":t,o=r.queryProcessor,n=r.resultPorcessor;return this.entities[e]={queryProcessor:o,resultPorcessor:n},""!==s&&(this.entities[e].url=s),this},e.prototype.initBaseTypes=function(){var e=this;this.registerEntityType("product",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"product",t,s)}}),this.registerEntityType("attribute",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"attribute",t,s)}}),this.registerEntityType("category",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"category",t,s)}}),this.registerEntityType("taxrule",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"taxrule",t,s)}}),this.registerEntityType("review",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"review",t,s)}}),this.registerEntityType("cms_page",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"cms_page",t,s)}}),this.registerEntityType("cms_block",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"cms_block",t,s)}}),this.registerEntityType("cms_hierarchy",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"cms_hierarchy",t,s)}})},e.prototype.initCustomTypes=function(){var e=this;this.registerEntityType("vortex_shipping_rate",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"vortex_shipping_rate",t,s)}}),this.registerEntityType("product_question",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"product_question",t,s)}}),this.registerEntityType("v12_finance_products",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"v12_finance_products",t,s)}}),this.registerEntityType("bikebuilder",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"bikebuilder",t,s)}}),this.registerEntityType("pos_displaybikes",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"pos_displaybikes",t,s)}}),this.registerEntityType("prespec",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"prespec",t,s)}}),this.registerEntityType("ayko_config",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"ayko_config",t,s)}}),this.registerEntityType("currency_rates",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"currency_rates",t,s)}}),this.registerEntityType("ayko_url_rewrite",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,s){return e.handleResult(r,"ayko_url_rewrite",t,s)}})},e}()}}]);